<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./static/bootstrap-3.3.6-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/font-awesome-4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="static/css/style.css">
    <script type="text/javascript" src="./static/js/socket.io.js"></script>
    <script type="text/javascript" src="./static/js/jquery-1.10.2.min.js"></script>
    <!--<script type="text/javascript" src="./static/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>-->

    <title>Full stack Notification System</title>
</head>
<body>

<div class="background"></div>
<header class="main-header">
    <form class="pa-l form-inline pull-left" role="form">
        <div class="form-group">
            <div class="col-xs-12">
                <span class="glyphicon glyphicon-search text-search grey-icon"></span>
                <input type="text" class="form-control" id="search-term"/>
            </div>
        </div>
    </form>
    <div class="pull-right user-info">
        <div class="pull-left">
            <div class="notification notif-hidden pa-l" onclick="notification.togglePanel(event)">
                <span class="bell-icon fa fa-bell-o grey-icon"></span>
                <span class="main-count tag hide"></span> <!-- Add hide class to hide it -->
            </div>
            <span class="mail-icon fa fa-envelope-o pa-l grey-icon"></span>
        </div>
        <div class="user-desc pull-right pa-l">
            <img src="static/img/user.jpg" class="user-img">
            <span class="glyphicon glyphicon-chevron-down gi-s mh-s dropdown white-icon"></span>
        </div>
    </div>
</header>
<div class="notif-container">
    <div class="header pa-l">
        <span>Notifications</span>
        <span class="main-count tag"></span>
    </div>
    <div class="list">

    </div>
</div>
</body>
<script>

    var notification = {
        getCount: function () {
            $.ajax({
                url: '/notifications/count',
                success: function(count){
                    //update the notification count
                    notification.update(count);
                },
                error: function(err) {
                    console.info('error : ', err);
                }
            });
        },
        get: function () {
            $.ajax({url: '/notifications',
                success: function(notifs){
                    notification.markAsRead(notifs);
                    //update the notification count
                    notification.renderList(notifs);
                },
                error: function(err) {
                    console.info('error : ', err);
                }
            });
        },
        markAsRead: function(notifs) {
            $.ajax({
                url: '/notifications/read',
                success: function(count){
                    //update the notification count
                    notification.update(count);
                },
                error: function(err) {
                    console.info('error : ', err);
                }
            });
        },
        update: function (notifs) {
            if(notifs.count > 0 && !$('.notif-container').hasClass('open')) {
                $('.notification .main-count').removeClass('hide');
                var node = document.getElementsByClassName('main-count');
                console.info(node);
                if(notifs.count < 100) {
                    for(var i = 0; i < node.length; i++) {
                        node[i].innerHTML = notifs.count;
                    }

                } else if(notifs.count > 0) {
                    for(var i = 0; i < node.length; i++) {
                        node[i].innerHTML = '99+';
                        node[i].style.fontSize = '9px';
                        node[i].style.lineHeight = '20px';
                    }
                }
            }
        },
        init: function () {
            var socket;

            notification.getCount();

            socket = io.connect();
            socket.on('notificationCount', function (count) {
                //update the notification count
                notification.update(count);
                //notification.get();
            });
        },
        togglePanel: function (e) {
            this.get();
            $('.notif-container').toggleClass('open');
            $('.notification .main-count').toggleClass('hide');
        },
        renderList: function (notifs) {
            $('.notification .main-count').addClass('hide');
            var notifDOM = document.getElementsByClassName("list")[0];
            notification.removeOldList(notifDOM, notifs.length);
            $('.list-item').addClass('read');

            notifs.forEach(function(notif) {
                var listNode = document.createElement("div");
                listNode.className = "list-item pa-l";
                var userImg = document.createElement("img");
                userImg.className = "pull-left";
                userImg.src = "static/img/"+ notif.user.imgName;
                var contentDiv = document.createElement("div");
                contentDiv.className = "content";
                contentDiv.innerHTML = '<span>'+ notif.user.firstName + ' </span>' + notif.desc;
                listNode.appendChild(userImg);
                listNode.appendChild(contentDiv);

                notifDOM.insertBefore(listNode, notifDOM.childNodes[1]);
            });
        },
        removeOldList: function(notifDOM, newNotifsLen) {
            if(notifDOM.children.length + newNotifsLen > 10) {
                if(newNotifsLen > 10) {
                    $(notifDOM).find(".list-item").slice(0).remove();
                } else {
                    $(notifDOM).find(".list-item").slice(10-newNotifsLen).remove();
                }
            }
        }
    };

    notification.init();

    $(document).click(function(){
        $(".notif-container").removeClass("open");
    });

    $(".notification, .notif-container").click(function(e){
        e.stopPropagation();
    });

    $(".list").scroll(function () {
        var list = $(".list");
        /*if ($(document).height() <= list.scrollTop() + list.height()) {
            alert("End Of The Page");
        }*/
    });

</script>
</html>